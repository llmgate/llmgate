<!DOCTYPE html>
<html>
<head>
    <title>Session Timeline Visualization</title>
    <style>
        body, html {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timeline-container {
            width: 100%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }
        .timeline {
            position: relative;
            margin: 0 auto;
            padding-left: 50px;
        }
        .timeline::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #3498db;
            top: 0;
            bottom: 0;
            left: 50px;
            margin-left: -3px;
        }
        .event {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: calc(100% - 90px);
            margin-bottom: 20px;
        }
        .event::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            left: -62px;
            background-color: #3498db;
            border: 4px solid #121212;
            top: 15px;
            border-radius: 50%;
            z-index: 1;
        }
        .content {
            padding: 20px 30px;
            background-color: #2c2c2c;
            position: relative;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }
        .content::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 22px;
            width: 0;
            z-index: 1;
            left: -10px;
            border: medium solid #2c2c2c;
            border-width: 10px 10px 10px 0;
            border-color: transparent #2c2c2c transparent transparent;
        }
        .error .content {
            background-color: #3c1f1e;
            border-left: 4px solid #e74c3c;
        }
        h2 {
            color: #3498db;
            margin-top: 0;
        }
        .json-preview {
            background-color: #1e1e1e;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: hidden;
            max-height: 70px;
            transition: max-height 0.3s ease-out, overflow 0.3s ease-out;
            cursor: pointer;
        }
        .json-preview.expanded {
            max-height: none;
            overflow-y: auto;
        }
        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        .json-boolean { color: #569cd6; }
        .json-null { color: #569cd6; }
    </style>
</head>
<body>
    <div class="timeline-container">
        <div class="timeline" id="timeline"></div>
    </div>

    <script>
        const data = JSON.parse({{.Data}});
        const timeline = document.getElementById('timeline');

        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                json = JSON.stringify(json, undefined, 2);
            }
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function createJsonPreview(jsonString, type) {
            const parsedJson = JSON.parse(jsonString);
            const highlightedJson = syntaxHighlight(parsedJson);
            const lines = highlightedJson.split('\n');
            const preview = lines.slice(0, 3).join('\n') + (lines.length > 3 ? '\n...' : '');
            
            const jsonPreview = document.createElement('div');
            jsonPreview.className = 'json-preview';
            jsonPreview.innerHTML = preview;
            jsonPreview.dataset.fullContent = highlightedJson;
            jsonPreview.dataset.preview = preview;
            
            return `<p><strong>${type}:</strong></p>` + jsonPreview.outerHTML;
        }

        function toggleJsonPreview(event) {
            const jsonPreview = event.target.closest('.json-preview');
            if (jsonPreview) {
                jsonPreview.classList.toggle('expanded');
                if (jsonPreview.classList.contains('expanded')) {
                    jsonPreview.innerHTML = jsonPreview.dataset.fullContent;
                } else {
                    jsonPreview.innerHTML = jsonPreview.dataset.preview;
                }
                event.stopPropagation();
            }
        }

        data.forEach((item, index) => {
            const event = document.createElement('div');
            event.className = 'event';
            if (item.error) {
                event.className += ' error';
            }
            
            const content = document.createElement('div');
            content.className = 'content';
            content.innerHTML = `
                <h2>Time: ${item.time}ms</h2>
                ${createJsonPreview(item.request, 'Request')}
                ${item.response ? createJsonPreview(item.response, 'Response') : ''}
                ${item.error ? `<p><strong>Error:</strong> ${item.error}</p>` : ''}
                <p><strong>Cost:</strong> $ ${item.cost}</p>
            `;
            
            content.addEventListener('click', toggleJsonPreview);
            
            event.appendChild(content);
            timeline.appendChild(event);
        });
    </script>
</body>
</html>